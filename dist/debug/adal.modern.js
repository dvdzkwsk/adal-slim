var e,t,n;!function(e){e.LOGIN="LOGIN",e.RENEW_TOKEN="RENEW_TOKEN",e.UNKNOWN="UNKNOWN"}(e||(e={})),function(e){e.ID_TOKEN="id_token token",e.TOKEN="token"}(t||(t={})),function(e){e.Canceled="Canceled",e.Completed="Completed",e.InProgress="In Progress"}(n||(n={}));let r=r=>{if(window._adalInstance)return window._adalInstance;let o,S;r=a(r);let k={},v=!1,b=!1,C=[],P=[],y={},A={},U=e.LOGIN;function W(e,t,n,r,o){K.warn(r),d(h.ERROR,n),d(h.ERROR_DESCRIPTION,r),d(h.LOGIN_ERROR,o),t&&k[t]&&(k[t]=null),v=!1,b=!1,e&&e(r,null,n)}function x(e,t,n){var o=function(e,t,n,r){try{const t=window.innerWidth/2-241.5+window.screenX,n=window.innerHeight/2-300+window.screenY,r=window.open(e,"login","width=483, height=600, top="+n+", left="+t);return r.focus&&r.focus(),r}catch(e){K.warn("Error opening popup, "+e.message),v=!1,b=!1}}(e),i=n||r.callback;if(!o){var a="Popup Window is null. This can happen if you are using IE";return void W(i,t,"Error opening popup",a,a)}P.push(o);const s=r.redirectUri.split("#")[0];let l=setInterval(()=>{if(!o||o.closed||void 0===o.closed){let e="Popup Window closed by UI action/ Popup Window handle destroyed due to cross zone navigation in IE/Edge";return W(i,t,"Popup Window closed",e,e),void clearInterval(l)}try{let e=o.location;if(-1!=encodeURI(e.href).indexOf(encodeURI(s)))return Q(e.hash),clearInterval(l),v=!1,b=!1,K.info("Closing popup window"),P=[],void o.close()}catch(e){}},1)}function L(e,t,n){k[t]=e,A[e]||(A[e]=[]),A[e].push(n),y[e]||(y[e]=(n,r,o,i)=>{k[t]=null;for(var a=0;a<A[e].length;++a)try{A[e][a](n,r,o,i)}catch(o){K.warn(o)}A[e]=null,y[e]=null})}function q(e,n,o="token"){K.info("renewToken is called for resource:"+e);let i=V("adalRenewFrame"+e),a=N()+"|"+e;r.state=a,C.push(a),K.verbose("Renew token Expected state: "+a);let l=c(X(o,e),"prompt");o===t.ID_TOKEN&&(S=N(),d(h.NONCE_IDTOKEN,S,!0),l+="&nonce="+s(S)),l+="&prompt=none",l=F(l),L(a,e,n),K.verbosePii("Navigate to:"+l),i.src="about:blank",G(l,"adalRenewFrame"+e,e)}function D(e,t){let n=V("adalIdTokenFrame"),o=N()+"|"+r.clientId;S=N(),d(h.NONCE_IDTOKEN,S,!0),r.state=o,C.push(o),K.verbose("Renew Idtoken Expected state: "+o);let i=t||r.clientId,a=c(X(t=t||"id_token",i),"prompt");a=F(a+"&prompt=none"),a+="&nonce="+s(S),L(o,r.clientId,e),K.verbosePii("Navigate to:"+a),n.src="about:blank",G(a,"adalIdTokenFrame",r.clientId)}function G(e,t,o){K.verbose("Set loading state to pending for: "+o),d(h.RENEW_STATUS+o,n.InProgress),function e(t,n){K.info("LoadFrame: "+n),setTimeout(()=>{const r=V(n);r.src&&"about:blank"!==r.src||(r.src=t,e(t,n))},500)}(e,t),setTimeout(()=>{if(T(h.RENEW_STATUS+o)===n.InProgress){K.verbose("Loading frame has timed out after: "+r.loadFrameTimeout/1e3+" seconds for resource "+o);var e=k[o];e&&y[e]&&y[e]("Token renewal operation failed due to timeout",null,"Token Renewal Failed"),d(h.RENEW_STATUS+o,n.Canceled)}},r.loadFrameTimeout)}function Y(e){e?(K.infoPii("Navigate to:"+e),window.location.replace(e)):K.info("Navigate url is empty")}function F(e){if(!o||!o.profile)return e;if(o.profile.sid&&-1!==e.indexOf("&prompt=none"))l("sid",e)||(e+="&sid="+s(o.profile.sid));else if(o.profile.upn&&(l("login_hint",e)||(e+="&login_hint="+s(o.profile.upn)),!l("domain_hint",e)&&o.profile.upn.indexOf("@")>-1)){var t=o.profile.upn.split("@");e+="&domain_hint="+s(t[t.length-1])}return e}function M(e){const t=function(e){let t=i(e);var n;if(t)try{let e=(n=(n=t.JWSPayload).replace(/-/g,"+").replace(/_/g,"/"),decodeURIComponent(escape(window.atob(n))));return e?JSON.parse(e):void K.info("The returned id_token could not be base64 url safe decoded.")}catch(e){K.error("The returned id_token could not be decoded",e)}}(e);if(w(t,"aud"))return t.aud.toLowerCase()===r.clientId.toLowerCase()?{userName:t.upn||t.email,profile:t}:void K.warn("IdToken has invalid aud field")}function Q(t=window.location.hash){if(!E(t))return;let n,r;const o=P[P.length-1];o&&o.opener&&o.opener._AuthenticationContextInstance?(n=o.opener._adalInstance,r=!0):window.parent&&window.parent._adalInstance&&(n=window.parent._adalInstance);let i,a,s,l=n.getRequestInfo(t);i=r||window.parent!==window?n._callBackMappedToRenewStates[l.stateResponse]:n.config.callback,n.saveTokenFromHash(l),l.requestType===e.RENEW_TOKEN&&window.parent?(window.parent!==window?K.verbose("Window is in iframe, acquiring token silently"):K.verbose("acquiring token interactive in progress"),a=l.parameters.access_token||l.parameters.id_token,s="access_token"):l.requestType===e.LOGIN&&(a=l.parameters.id_token,s="id_token");try{i&&i(l.parameters.error_description,a,l.parameters.error,s)}catch(e){K.error("Error occurred in user defined callback function: "+e)}window.parent!==window||r||(n.config.navigateToLoginRequestUrl?window.location.href=T(h.LOGIN_REQUEST):window.location.hash="")}let X=(e,t)=>r.instance+r.tenant+"/oauth2/authorize"+O(e,r,t);function V(e){return document.getElementById(e)||(K.info("Add adal frame to document:"+e),document.body.insertAdjacentHTML("beforeEnd",`<iframe name="${e}" id="${e}" style="display:none"></iframe>`),window.frames&&window.frames[e])}return window._adalInstance={config:r,login:function(){if(v)return void K.info("Login in progress");v=!0;const e=N(),t=window.location.href;r.state=e,S=N(),K.verbose("Expected state: "+e+" startPage:"+t),d(h.LOGIN_REQUEST,t),d(h.LOGIN_ERROR,""),d(h.STATE_LOGIN,e,!0),d(h.NONCE_IDTOKEN,S,!0),d(h.ERROR,""),d(h.ERROR_DESCRIPTION,"");const n=X("id_token")+"&nonce="+s(S);r.displayCall?r.displayCall(n):r.popUp?(d(h.STATE_LOGIN,""),C.push(e),L(e,r.clientId,r.callback),x(n)):Y(n)},logout:function(){let e;if(function(){d(h.LOGIN_REQUEST,""),d(h.SESSION_STATE,""),d(h.STATE_LOGIN,""),d(h.STATE_RENEW,""),C=[],d(h.NONCE_IDTOKEN,""),d(h.IDTOKEN,""),d(h.ERROR,""),d(h.ERROR_DESCRIPTION,""),d(h.LOGIN_ERROR,""),d(h.LOGIN_ERROR,"");var e=T(h.TOKEN_KEYS);if(!g(e)){e=e.split("|");for(var t=0;t<e.length&&""!==e[t];t++)d(h.ACCESS_TOKEN_KEY+e[t],""),d(h.EXPIRATION_KEY+e[t],0)}d(h.TOKEN_KEYS,"")}(),o=null,r.logOutUri)e=r.logOutUri;else{let t="";r.postLogoutRedirectUri&&(t="post_logout_redirect_uri="+s(r.postLogoutRedirectUri)),e=r.instance+r.tenant+"/oauth2/logout?"+t}K.infoPii("Logout navigate to: "+e),Y(e)},getUser:function(){if(!o){const e=T(h.IDTOKEN);e&&(o=M(e))}return o},registerCallback:L,acquireToken:function(n,i){if(!n){const e="resource is required";return K.warn(e),void i(e,null,e)}const a=function(e){if(!u(e))return;const t=T(h.ACCESS_TOKEN_KEY+e),n=T(h.EXPIRATION_KEY+e);if(n&&n>m()+r.expireOffsetSeconds)return t;d(h.ACCESS_TOKEN_KEY+e,""),d(h.EXPIRATION_KEY+e,0)}(n);if(a)return K.info("Token is already in cache for resource:"+n),void i(null,a,null);if(!(o||r.extraQueryParameter&&-1!==r.extraQueryParameter.indexOf("login_hint"))){const e="User login is required";return K.warn(e),void i(e,null,e)}k[n]?L(k[n],n,i):(U=e.RENEW_TOKEN,n===r.clientId?o?(K.verbose("renewing idtoken"),D(i)):(K.verbose("renewing idtoken and access_token"),D(i,t.ID_TOKEN)):o?(K.verbose("renewing access_token"),q(n,i)):(K.verbose("renewing idtoken and access_token"),q(n,i,t.ID_TOKEN)))},acquireTokenPopup:function(t,n,i,a){if(function(e){let t;return e?o?b&&(t="Acquire token interactive is already in progress"):t="User login is required":t="Resource is required",t&&(K.warn(t),r.callback(t,null,t)),!t}(t)){var l=N()+"|"+t;r.state=l,C.push(l),U=e.RENEW_TOKEN,K.verbose("Renew token Expected state: "+l);var d=c(X("token",t),"prompt");if(d+="&prompt=select_account",n&&(d+=n),i){if(-1!==d.indexOf("&claims"))throw new Error("Claims cannot be passed as an extraQueryParameter");d+="&claims="+s(i)}d=F(d),b=!0,K.info("acquireToken interactive is called for the resource "+t),L(l,t,a),x(d,t,a)}},getRequestInfo:function(t){const n={valid:!1,parameters:{},stateMatch:!1,stateResponse:"",requestType:e.UNKNOWN},r=_(p(t));if(!r)return n;if(n.parameters=r,w(r,"error_description")||w(r,"access_token")||w(r,"id_token")){if(n.valid=!0,!w(r,"state"))return K.warn("No state returned"),n;if(K.verbose("State: "+r.state),n.stateResponse=r.state,function(t){const n=T(h.STATE_LOGIN);if(n)for(const r of n.split("||"))if(r===t.stateResponse)return t.requestType=e.LOGIN,t.stateMatch=!0,!0;const r=T(h.STATE_RENEW);if(r)for(const n of r.split("||"))if(n===t.stateResponse)return t.requestType=e.RENEW_TOKEN,t.stateMatch=!0,!0;return!1}(n))return n;if(!n.stateMatch&&window.parent){n.requestType=U;for(const e of C)if(e===n.stateResponse){n.stateMatch=!0;break}}}return n},saveTokenFromHash:function(t){K.info("State status:"+t.stateMatch+"; Request type:"+t.requestType),d(h.ERROR,""),d(h.ERROR_DESCRIPTION,"");let i=R(t.stateResponse);if(w(t.parameters,"error_description"))K.infoPii("Error :"+t.parameters.error+"; Error description:"+t.parameters.error_description),d(h.ERROR,t.parameters.error),d(h.ERROR_DESCRIPTION,t.parameters.error_description),t.requestType===e.LOGIN&&(v=!1,d(h.LOGIN_ERROR,t.parameters.error_description));else if(t.stateMatch){let e;if(K.info("State is right"),w(t.parameters,"session_state")&&d(h.SESSION_STATE,t.parameters.session_state),w(t.parameters,"access_token")&&(K.info("Fragment has access token"),u(i)||(e=T(h.TOKEN_KEYS)||"",d(h.TOKEN_KEYS,e+i+"|")),d(h.ACCESS_TOKEN_KEY+i,t.parameters.access_token),d(h.EXPIRATION_KEY+i,I(t.parameters.expires_in))),w(t.parameters,"id_token"))if(v=!1,o=M(t.parameters.id_token),o&&o.profile)f(o)?(d(h.IDTOKEN,t.parameters.id_token),i=r.loginResource?r.loginResource:r.clientId,u(i)||(e=T(h.TOKEN_KEYS)||"",d(h.TOKEN_KEYS,e+i+"|")),d(h.ACCESS_TOKEN_KEY+i,t.parameters.id_token),d(h.EXPIRATION_KEY+i,o.profile.exp)):(d(h.LOGIN_ERROR,"Nonce received: "+o.profile.nonce+" is not same as requested: "+T(h.NONCE_IDTOKEN)),o=null);else{const e="invalid id_token",n="Invalid id_token. id_token: "+t.parameters.id_token;t.parameters.error=e,t.parameters.error_description=n,d(h.ERROR,e),d(h.ERROR_DESCRIPTION,n)}}else{const e="Invalid_state",n="Invalid_state. state: "+t.stateResponse;t.parameters.error=e,t.parameters.error_description=n,d(h.ERROR,e),d(h.ERROR_DESCRIPTION,n)}d(h.RENEW_STATUS+i,n.Completed)},loginInProgress:()=>v,handleWindowCallback:Q,_callBackMappedToRenewStates:y,_callBacksMappedToRenewStates:A}},o=e=>{d(h.STATE_RENEW,""),d(h.ERROR,""),d(h.ERROR_DESCRIPTION,""),u(e)&&(d(h.ACCESS_TOKEN_KEY+e,""),d(h.EXPIRATION_KEY+e,0))},i=e=>{if(g(e))return;let t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(t&&!(t.length<4))return{header:t[1],JWSPayload:t[2],JWSSig:t[3]};K.warn("The returned id_token is not parseable.")},a=e=>(e={popUp:!1,instance:"https://login.microsoftonline.com/",loginResource:e.clientId,laodFrameTimeout:6e3,expireOffsetSeconds:300,navigateToLoginRequestUrl:!0,tenant:"common",redirectUri:window.location.href.split("?")[0].split("#")[0],callback:()=>{},...e},K.correlationId=e.correlationId,e),s=e=>encodeURIComponent(e),l=(e,t)=>new RegExp("[\\?&]"+e+"=").test(t),c=(e,t)=>e.replace(new RegExp("(\\&"+t+"=)[^&]+"),"").replace(new RegExp("("+t+"=)[^&]+&"),"").replace(new RegExp("("+t+"=)[^&]+"),""),d=(e,t,n=!1)=>{if(n){let n=T(e)||"";S.setItem(e,n+t+"||")}else S.setItem(e,t)},u=e=>{let t=T(h.TOKEN_KEYS);return!g(t)&&t.indexOf(e+"|")>-1},p=e=>e.indexOf("#/")>-1?e.substring(e.indexOf("#/")+2):e.indexOf("#")>-1?e.substring(1):e,E=e=>{const t=_(p(e));return w(t,"error_description")||w(t,"access_token")||w(t,"id_token")},_=e=>{let t=/\+/g,n=/([^&=]+)=([^&]*)/g,r=e=>decodeURIComponent(e.replace(t," ")),o={},i=n.exec(e);for(;i;)o[r(i[1])]=r(i[2]),i=n.exec(e);return o},f=e=>{const t=T(h.NONCE_IDTOKEN);if(t)for(const n of t.split("||"))if(n===e.profile.nonce)return!0;return!1},R=e=>{if(e){let t=e.indexOf("|");if(t>-1&&t+1<e.length)return e.substring(t+1)}return""},I=e=>(e||(e=3599),m()+parseInt(e,10)),O=(e,t,n)=>{if(!t)return"";const r=["?response_type="+e,"client_id="+s(t.clientId)];n&&r.push("resource="+s(n)),r.push("redirect_uri="+s(t.redirectUri)),r.push("state="+s(t.state)),w(t,"slice")&&r.push("slice="+s(t.slice)),w(t,"extraQueryParameter")&&r.push(t.extraQueryParameter);const o=t.correlationId||N();return r.push("client-request-id="+s(o)),r.join("&")},N=()=>{let e=new Uint8Array(16);return crypto.getRandomValues(e),e[6]|=64,e[6]&=79,e[8]|=128,e[8]&=191,e=e.map(e=>{let t=e.toString(16);for(;t.length<2;)t="0"+t;return t}),e[0]+e[1]+e[2]+e[3]+"-"+e[4]+e[5]+"-"+e[6]+e[7]+"-"+e[8]+e[9]+"-"+e[10]+e[11]+e[12]+e[13]+e[14]+e[15]},T=e=>S.getItem(e),g=e=>!e||!e.length,w=(e,t)=>Object.hasOwnProperty.call(e,t),m=()=>Math.round(Date.now()/1e3);var h;!function(e){e.TOKEN_KEYS="adal.token.keys",e.ACCESS_TOKEN_KEY="adal.access.token.key",e.EXPIRATION_KEY="adal.expiration.key",e.STATE_LOGIN="adal.state.login",e.STATE_RENEW="adal.state.renew",e.NONCE_IDTOKEN="adal.nonce.idtoken",e.SESSION_STATE="adal.session.state",e.USERNAME="adal.username",e.IDTOKEN="adal.idtoken",e.ERROR="adal.error",e.ERROR_DESCRIPTION="adal.error.description",e.LOGIN_REQUEST="adal.login.request",e.LOGIN_ERROR="adal.login.error",e.RENEW_STATUS="adal.token.renew.status"}(h||(h={}));const S=(()=>{function e(e){const t=window[e];return!!t&&(t.setItem("__test__","__test__"),"__test__"===t.getItem("__test__")&&(t.removeItem("__test__"),!t.getItem("__test__")))}return e("localStorage")?localStorage:e("sessionStorage")?sessionStorage:{getItem(){},setItem(){}}})();var k;!function(e){e[e.Error=0]="Error",e[e.Warn=1]="Warn",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose"}(k||(k={}));const v={[k.Error]:"ERROR",[k.Warn]:"WARNING",[k.Info]:"INFO",[k.Verbose]:"VERBOSE"},K={pii:!1,correlationId:void 0,level:k.Error,log(e,t,n,r=!1){if((!r||this.pii)&&e<=this.level){let r=(new Date).toUTCString()+":"+(this.correlationId?this.correlationId+"-":"")+v[e]+": "+t;n&&(r+="\nstack:\n"+n.stack),console.log(r)}},error(e,t){this.log(k.Error,e,t)},warn(e){this.log(k.Warn,e,null)},info(e){this.log(k.Info,e,null)},verbose(e){this.log(k.Verbose,e,null)},errorPii(e,t){this.log(k.Error,e,t,!0)},warnPii(e){this.log(k.Warn,e,null,!0)},infoPii(e){this.log(k.Info,e,null,!0)},verbosePii(e){this.log(k.Verbose,e,null,!0)}};export{r as AuthenticationContext,k as LogLevel,o as clearCacheForResource};
//# sourceMappingURL=adal.modern.js.map
