function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var t,n,r;!function(e){e.LOGIN="LOGIN",e.RENEW_TOKEN="RENEW_TOKEN",e.UNKNOWN="UNKNOWN"}(t||(t={})),function(e){e.ID_TOKEN="id_token token",e.TOKEN="token"}(n||(n={})),function(e){e.Canceled="Canceled",e.Completed="Completed",e.InProgress="In Progress"}(r||(r={}));let o=e=>{if(window._adalInstance)return window._adalInstance;let o,i;e=s(e);let k={},v=!1,K=!1,C=[],P=[],y={},A={},U=t.LOGIN;function W(e,t,n,r,o){b.warn(r),u(S.ERROR,n),u(S.ERROR_DESCRIPTION,r),u(S.LOGIN_ERROR,o),t&&k[t]&&(k[t]=null),v=!1,K=!1,e&&e(r,null,n)}function x(t,n,r){var o=function(e,t,n,r){try{const t=window.innerWidth/2-241.5+window.screenX,n=window.innerHeight/2-300+window.screenY,r=window.open(e,"login","width=483, height=600, top="+n+", left="+t);return r.focus&&r.focus(),r}catch(e){b.warn("Error opening popup, "+e.message),v=!1,K=!1}}(t),i=r||e.callback;if(!o){var a="Popup Window is null. This can happen if you are using IE";return void W(i,n,"Error opening popup",a,a)}P.push(o);const s=e.redirectUri.split("#")[0];let l=setInterval(()=>{if(!o||o.closed||void 0===o.closed){let e="Popup Window closed by UI action/ Popup Window handle destroyed due to cross zone navigation in IE/Edge";return W(i,n,"Popup Window closed",e,e),void clearInterval(l)}try{let e=o.location;if(-1!=encodeURI(e.href).indexOf(encodeURI(s)))return X(e.hash),clearInterval(l),v=!1,K=!1,b.info("Closing popup window"),P=[],void o.close()}catch(e){}},1)}function L(e,t,n){k[t]=e,A[e]||(A[e]=[]),A[e].push(n),y[e]||(y[e]=(n,r,o,i)=>{k[t]=null;for(var a=0;a<A[e].length;++a)try{A[e][a](n,r,o,i)}catch(o){b.warn(o)}A[e]=null,y[e]=null})}function q(t,r,o="token"){b.info("renewToken is called for resource:"+t);let a=j("adalRenewFrame"+t),s=T()+"|"+t;e.state=s,C.push(s),b.verbose("Renew token Expected state: "+s);let c=d(V(o,t),"prompt");o===n.ID_TOKEN&&(i=T(),u(S.NONCE_IDTOKEN,i,!0),c+="&nonce="+l(i)),c+="&prompt=none",c=M(c),L(s,t,r),b.verbosePii("Navigate to:"+c),a.src="about:blank",G(c,"adalRenewFrame"+t,t)}function D(t,n){let r=j("adalIdTokenFrame"),o=T()+"|"+e.clientId;i=T(),u(S.NONCE_IDTOKEN,i,!0),e.state=o,C.push(o),b.verbose("Renew Idtoken Expected state: "+o);let a=n||e.clientId,s=d(V(n=n||"id_token",a),"prompt");s=M(s+"&prompt=none"),s+="&nonce="+l(i),L(o,e.clientId,t),b.verbosePii("Navigate to:"+s),r.src="about:blank",G(s,"adalIdTokenFrame",e.clientId)}function G(t,n,o){b.verbose("Set loading state to pending for: "+o),u(S.RENEW_STATUS+o,r.InProgress),Y(t,n),setTimeout(()=>{if(g(S.RENEW_STATUS+o)===r.InProgress){b.verbose("Loading frame has timed out after: "+e.loadFrameTimeout/1e3+" seconds for resource "+o);var t=k[o];t&&y[t]&&y[t]("Token renewal operation failed due to timeout",null,"Token Renewal Failed"),u(S.RENEW_STATUS+o,r.Canceled)}},e.loadFrameTimeout)}function Y(e,t){b.info("LoadFrame: "+t),setTimeout(()=>{const n=j(t);n.src&&"about:blank"!==n.src||(n.src=e,Y(e,t))},500)}function F(e){e?(b.infoPii("Navigate to:"+e),window.location.replace(e)):b.info("Navigate url is empty")}function M(e){if(!o||!o.profile)return e;if(o.profile.sid&&-1!==e.indexOf("&prompt=none"))c("sid",e)||(e+="&sid="+l(o.profile.sid));else if(o.profile.upn&&(c("login_hint",e)||(e+="&login_hint="+l(o.profile.upn)),!c("domain_hint",e)&&o.profile.upn.indexOf("@")>-1)){var t=o.profile.upn.split("@");e+="&domain_hint="+l(t[t.length-1])}return e}function Q(t){const n=function(e){let t=a(e);var n;if(t)try{let e=(n=(n=t.JWSPayload).replace(/-/g,"+").replace(/_/g,"/"),decodeURIComponent(escape(window.atob(n))));return e?JSON.parse(e):void b.info("The returned id_token could not be base64 url safe decoded.")}catch(e){b.error("The returned id_token could not be decoded",e)}}(t);if(m(n,"aud"))return n.aud.toLowerCase()===e.clientId.toLowerCase()?{userName:n.upn||n.email,profile:n}:void b.warn("IdToken has invalid aud field")}function X(e=window.location.hash){if(!f(e))return;let n,r;const o=P[P.length-1];o&&o.opener&&o.opener._AuthenticationContextInstance?(n=o.opener._adalInstance,r=!0):window.parent&&window.parent._adalInstance&&(n=window.parent._adalInstance);let i,a,s,l=n.getRequestInfo(e);i=r||window.parent!==window?n._callBackMappedToRenewStates[l.stateResponse]:n.config.callback,n.saveTokenFromHash(l),l.requestType===t.RENEW_TOKEN&&window.parent?(window.parent!==window?b.verbose("Window is in iframe, acquiring token silently"):b.verbose("acquiring token interactive in progress"),a=l.parameters.access_token||l.parameters.id_token,s="access_token"):l.requestType===t.LOGIN&&(a=l.parameters.id_token,s="id_token");try{i&&i(l.parameters.error_description,a,l.parameters.error,s)}catch(e){b.error("Error occurred in user defined callback function: "+e)}window.parent!==window||r||(n.config.navigateToLoginRequestUrl?window.location.href=g(S.LOGIN_REQUEST):window.location.hash="")}let V=(t,n)=>e.instance+e.tenant+"/oauth2/authorize"+N(t,e,n);function j(e){return document.getElementById(e)||(b.info("Add adal frame to document:"+e),document.body.insertAdjacentHTML("beforeEnd",`<iframe name="${e}" id="${e}" style="display:none"></iframe>`),window.frames&&window.frames[e])}return window._adalInstance={config:e,login:function(){if(v)return void b.info("Login in progress");v=!0;const t=T(),n=window.location.href;e.state=t,i=T(),b.verbose("Expected state: "+t+" startPage:"+n),u(S.LOGIN_REQUEST,n),u(S.LOGIN_ERROR,""),u(S.STATE_LOGIN,t,!0),u(S.NONCE_IDTOKEN,i,!0),u(S.ERROR,""),u(S.ERROR_DESCRIPTION,"");const r=V("id_token")+"&nonce="+l(i);e.displayCall?e.displayCall(r):e.popUp?(u(S.STATE_LOGIN,""),C.push(t),L(t,e.clientId,e.callback),x(r)):F(r)},logout:function(){let t;if(function(){u(S.LOGIN_REQUEST,""),u(S.SESSION_STATE,""),u(S.STATE_LOGIN,""),u(S.STATE_RENEW,""),C=[],u(S.NONCE_IDTOKEN,""),u(S.IDTOKEN,""),u(S.ERROR,""),u(S.ERROR_DESCRIPTION,""),u(S.LOGIN_ERROR,""),u(S.LOGIN_ERROR,"");var e=g(S.TOKEN_KEYS);if(!w(e)){e=e.split("|");for(var t=0;t<e.length&&""!==e[t];t++)u(S.ACCESS_TOKEN_KEY+e[t],""),u(S.EXPIRATION_KEY+e[t],0)}u(S.TOKEN_KEYS,"")}(),o=null,e.logOutUri)t=e.logOutUri;else{let n="";e.postLogoutRedirectUri&&(n="post_logout_redirect_uri="+l(e.postLogoutRedirectUri)),t=e.instance+e.tenant+"/oauth2/logout?"+n}b.infoPii("Logout navigate to: "+t),F(t)},getUser:function(){if(!o){const e=g(S.IDTOKEN);e&&(o=Q(e))}return o},registerCallback:L,acquireToken:function(r,i){if(!r){const e="resource is required";return b.warn(e),void i(e,null,e)}const a=function(t){if(!p(t))return;const n=g(S.ACCESS_TOKEN_KEY+t),r=g(S.EXPIRATION_KEY+t);if(r&&r>h()+e.expireOffsetSeconds)return n;u(S.ACCESS_TOKEN_KEY+t,""),u(S.EXPIRATION_KEY+t,0)}(r);if(a)return b.info("Token is already in cache for resource:"+r),void i(null,a,null);if(!(o||e.extraQueryParameter&&-1!==e.extraQueryParameter.indexOf("login_hint"))){const e="User login is required";return b.warn(e),void i(e,null,e)}k[r]?L(k[r],r,i):(U=t.RENEW_TOKEN,r===e.clientId?o?(b.verbose("renewing idtoken"),D(i)):(b.verbose("renewing idtoken and access_token"),D(i,n.ID_TOKEN)):o?(b.verbose("renewing access_token"),q(r,i)):(b.verbose("renewing idtoken and access_token"),q(r,i,n.ID_TOKEN)))},acquireTokenPopup:function(n,r,i,a){if(function(t){let n;return t?o?K&&(n="Acquire token interactive is already in progress"):n="User login is required":n="Resource is required",n&&(b.warn(n),e.callback(n,null,n)),!n}(n)){var s=T()+"|"+n;e.state=s,C.push(s),U=t.RENEW_TOKEN,b.verbose("Renew token Expected state: "+s);var c=d(V("token",n),"prompt");if(c+="&prompt=select_account",r&&(c+=r),i){if(-1!==c.indexOf("&claims"))throw new Error("Claims cannot be passed as an extraQueryParameter");c+="&claims="+l(i)}c=M(c),K=!0,b.info("acquireToken interactive is called for the resource "+n),L(s,n,a),x(c,n,a)}},getRequestInfo:function(e){const n={valid:!1,parameters:{},stateMatch:!1,stateResponse:"",requestType:t.UNKNOWN},r=R(E(e));if(!r)return n;if(n.parameters=r,m(r,"error_description")||m(r,"access_token")||m(r,"id_token")){if(n.valid=!0,!m(r,"state"))return b.warn("No state returned"),n;if(b.verbose("State: "+r.state),n.stateResponse=r.state,function(e){const n=g(S.STATE_LOGIN);if(n)for(const r of n.split("||"))if(r===e.stateResponse)return e.requestType=t.LOGIN,e.stateMatch=!0,!0;const r=g(S.STATE_RENEW);if(r)for(const n of r.split("||"))if(n===e.stateResponse)return e.requestType=t.RENEW_TOKEN,e.stateMatch=!0,!0;return!1}(n))return n;if(!n.stateMatch&&window.parent){n.requestType=U;for(const e of C)if(e===n.stateResponse){n.stateMatch=!0;break}}}return n},saveTokenFromHash:function(n){b.info("State status:"+n.stateMatch+"; Request type:"+n.requestType),u(S.ERROR,""),u(S.ERROR_DESCRIPTION,"");let i=I(n.stateResponse);if(m(n.parameters,"error_description"))b.infoPii("Error :"+n.parameters.error+"; Error description:"+n.parameters.error_description),u(S.ERROR,n.parameters.error),u(S.ERROR_DESCRIPTION,n.parameters.error_description),n.requestType===t.LOGIN&&(v=!1,u(S.LOGIN_ERROR,n.parameters.error_description));else if(n.stateMatch){let t;if(b.info("State is right"),m(n.parameters,"session_state")&&u(S.SESSION_STATE,n.parameters.session_state),m(n.parameters,"access_token")&&(b.info("Fragment has access token"),p(i)||(t=g(S.TOKEN_KEYS)||"",u(S.TOKEN_KEYS,t+i+"|")),u(S.ACCESS_TOKEN_KEY+i,n.parameters.access_token),u(S.EXPIRATION_KEY+i,O(n.parameters.expires_in))),m(n.parameters,"id_token"))if(v=!1,o=Q(n.parameters.id_token),o&&o.profile)_(o)?(u(S.IDTOKEN,n.parameters.id_token),i=e.loginResource?e.loginResource:e.clientId,p(i)||(t=g(S.TOKEN_KEYS)||"",u(S.TOKEN_KEYS,t+i+"|")),u(S.ACCESS_TOKEN_KEY+i,n.parameters.id_token),u(S.EXPIRATION_KEY+i,o.profile.exp)):(u(S.LOGIN_ERROR,"Nonce received: "+o.profile.nonce+" is not same as requested: "+g(S.NONCE_IDTOKEN)),o=null);else{const e="invalid id_token",t="Invalid id_token. id_token: "+n.parameters.id_token;n.parameters.error=e,n.parameters.error_description=t,u(S.ERROR,e),u(S.ERROR_DESCRIPTION,t)}}else{const e="Invalid_state",t="Invalid_state. state: "+n.stateResponse;n.parameters.error=e,n.parameters.error_description=t,u(S.ERROR,e),u(S.ERROR_DESCRIPTION,t)}u(S.RENEW_STATUS+i,r.Completed)},loginInProgress:()=>v,handleWindowCallback:X,_callBackMappedToRenewStates:y,_callBacksMappedToRenewStates:A}},i=e=>{u(S.STATE_RENEW,""),u(S.ERROR,""),u(S.ERROR_DESCRIPTION,""),p(e)&&(u(S.ACCESS_TOKEN_KEY+e,""),u(S.EXPIRATION_KEY+e,0))},a=e=>{if(w(e))return;let t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(t&&!(t.length<4))return{header:t[1],JWSPayload:t[2],JWSSig:t[3]};b.warn("The returned id_token is not parseable.")},s=t=>(t=e({popUp:!1,instance:"https://login.microsoftonline.com/",loginResource:t.clientId,laodFrameTimeout:6e3,expireOffsetSeconds:300,navigateToLoginRequestUrl:!0,tenant:"common",redirectUri:window.location.href.split("?")[0].split("#")[0],callback:()=>{}},t),b.correlationId=t.correlationId,t),l=e=>encodeURIComponent(e),c=(e,t)=>new RegExp("[\\?&]"+e+"=").test(t),d=(e,t)=>e.replace(new RegExp("(\\&"+t+"=)[^&]+"),"").replace(new RegExp("("+t+"=)[^&]+&"),"").replace(new RegExp("("+t+"=)[^&]+"),""),u=(e,t,n=!1)=>{if(n){let n=g(e)||"";k.setItem(e,n+t+"||")}else k.setItem(e,t)},p=e=>{let t=g(S.TOKEN_KEYS);return!w(t)&&t.indexOf(e+"|")>-1},E=e=>e.indexOf("#/")>-1?e.substring(e.indexOf("#/")+2):e.indexOf("#")>-1?e.substring(1):e,f=e=>{const t=R(E(e));return m(t,"error_description")||m(t,"access_token")||m(t,"id_token")},R=e=>{let t=/\+/g,n=/([^&=]+)=([^&]*)/g,r=e=>decodeURIComponent(e.replace(t," ")),o={},i=n.exec(e);for(;i;)o[r(i[1])]=r(i[2]),i=n.exec(e);return o},_=e=>{const t=g(S.NONCE_IDTOKEN);if(t)for(const n of t.split("||"))if(n===e.profile.nonce)return!0;return!1},I=e=>{if(e){let t=e.indexOf("|");if(t>-1&&t+1<e.length)return e.substring(t+1)}return""},O=e=>(e||(e=3599),h()+parseInt(e,10)),N=(e,t,n)=>{if(!t)return"";const r=["?response_type="+e,"client_id="+l(t.clientId)];n&&r.push("resource="+l(n)),r.push("redirect_uri="+l(t.redirectUri)),r.push("state="+l(t.state)),m(t,"slice")&&r.push("slice="+l(t.slice)),m(t,"extraQueryParameter")&&r.push(t.extraQueryParameter);const o=t.correlationId||T();return r.push("client-request-id="+l(o)),r.join("&")},T=()=>{let e=new Uint8Array(16);return crypto.getRandomValues(e),e[6]|=64,e[6]&=79,e[8]|=128,e[8]&=191,e=e.map(e=>{let t=e.toString(16);for(;t.length<2;)t="0"+t;return t}),e[0]+e[1]+e[2]+e[3]+"-"+e[4]+e[5]+"-"+e[6]+e[7]+"-"+e[8]+e[9]+"-"+e[10]+e[11]+e[12]+e[13]+e[14]+e[15]},g=e=>k.getItem(e),w=e=>!e||!e.length,m=(e,t)=>Object.hasOwnProperty.call(e,t),h=()=>Math.round(Date.now()/1e3);var S;!function(e){e.TOKEN_KEYS="adal.token.keys",e.ACCESS_TOKEN_KEY="adal.access.token.key",e.EXPIRATION_KEY="adal.expiration.key",e.STATE_LOGIN="adal.state.login",e.STATE_RENEW="adal.state.renew",e.NONCE_IDTOKEN="adal.nonce.idtoken",e.SESSION_STATE="adal.session.state",e.USERNAME="adal.username",e.IDTOKEN="adal.idtoken",e.ERROR="adal.error",e.ERROR_DESCRIPTION="adal.error.description",e.LOGIN_REQUEST="adal.login.request",e.LOGIN_ERROR="adal.login.error",e.RENEW_STATUS="adal.token.renew.status"}(S||(S={}));const k=(()=>{function e(e){const t=window[e];if(!t)return!1;const n="__test__";return t.setItem(n,n),t.getItem(n)===n&&(t.removeItem(n),!t.getItem(n))}return e("localStorage")?localStorage:e("sessionStorage")?sessionStorage:{getItem(){},setItem(){}}})();var v;!function(e){e[e.Error=0]="Error",e[e.Warn=1]="Warn",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose"}(v||(v={}));const K={[v.Error]:"ERROR",[v.Warn]:"WARNING",[v.Info]:"INFO",[v.Verbose]:"VERBOSE"},b={pii:!1,correlationId:void 0,level:v.Error,log(e,t,n,r=!1){if((!r||this.pii)&&e<=this.level){let r=(new Date).toUTCString()+":"+(this.correlationId?this.correlationId+"-":"")+K[e]+": "+t;n&&(r+="\nstack:\n"+n.stack),console.log(r)}},error(e,t){this.log(v.Error,e,t)},warn(e){this.log(v.Warn,e,null)},info(e){this.log(v.Info,e,null)},verbose(e){this.log(v.Verbose,e,null)},errorPii(e,t){this.log(v.Error,e,t,!0)},warnPii(e){this.log(v.Warn,e,null,!0)},infoPii(e){this.log(v.Info,e,null,!0)},verbosePii(e){this.log(v.Verbose,e,null,!0)}};export{o as AuthenticationContext,v as LogLevel,i as clearCacheForResource};
//# sourceMappingURL=adal.modern.js.map
