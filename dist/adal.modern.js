function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var t,n,r;!function(e){e.LOGIN="LOGIN",e.RENEW_TOKEN="RENEW_TOKEN",e.UNKNOWN="UNKNOWN"}(t||(t={})),function(e){e.ID_TOKEN="id_token token",e.TOKEN="token"}(n||(n={})),function(e){e.Canceled="Canceled",e.Completed="Completed",e.InProgress="In Progress"}(r||(r={}));let o=e=>{if(window._adalInstance)return window._adalInstance;let o,a;e=s(e);let K={},k=!1,C=!1,v=[],y=[],A={},P={},U=t.LOGIN;function x(e,t,n,r,o){p(h.ERROR,n),p(h.ERROR_DESCRIPTION,r),p(h.LOGIN_ERROR,o),t&&K[t]&&(K[t]=null),k=!1,C=!1,e&&e(r,null,n)}function L(t,n,r){var o=function(e,t,n,r){try{const t=window.innerWidth/2-241.5+window.screenX,n=window.innerHeight/2-300+window.screenY,r=window.open(e,"login","width=483, height=600, top="+n+", left="+t);return r.focus&&r.focus(),r}catch(e){k=!1,C=!1}}(t),a=r||e.callback;if(!o){var i="Popup Window is null. This can happen if you are using IE";return void x(a,n,"Error opening popup",i,i)}y.push(o);const s=e.redirectUri.split("#")[0];let l=setInterval(()=>{if(!o||o.closed||void 0===o.closed){let e="Popup Window closed by UI action/ Popup Window handle destroyed due to cross zone navigation in IE/Edge";return x(a,n,"Popup Window closed",e,e),void clearInterval(l)}try{let e=o.location;if(-1!=encodeURI(e.href).indexOf(encodeURI(s)))return Q(e.hash),clearInterval(l),k=!1,C=!1,y=[],void o.close()}catch(e){}},1)}function W(e,t,n){K[t]=e,P[e]||(P[e]=[]),P[e].push(n),A[e]||(A[e]=(n,r,o,a)=>{K[t]=null;for(var i=0;i<P[e].length;++i)try{P[e][i](n,r,o,a)}catch(o){}P[e]=null,A[e]=null})}function b(t,r,o="token"){let i=j("adalRenewFrame"+t),s=T()+"|"+t;e.state=s,v.push(s);let c=d(X(o,t),"prompt");o===n.ID_TOKEN&&(a=T(),p(h.NONCE_IDTOKEN,a,!0),c+="&nonce="+l(a)),c+="&prompt=none",c=M(c),W(s,t,r),i.src="about:blank",Y(c,"adalRenewFrame"+t,t)}function D(t,n){let r=j("adalIdTokenFrame"),o=T()+"|"+e.clientId;a=T(),p(h.NONCE_IDTOKEN,a,!0),e.state=o,v.push(o);let i=n||e.clientId,s=d(X(n=n||"id_token",i),"prompt");s=M(s+"&prompt=none"),s+="&nonce="+l(a),W(o,e.clientId,t),r.src="about:blank",Y(s,"adalIdTokenFrame",e.clientId)}function Y(t,n,o){p(h.RENEW_STATUS+o,r.InProgress),G(t,n),setTimeout(()=>{if(m(h.RENEW_STATUS+o)===r.InProgress){var e=K[o];e&&A[e]&&A[e]("Token renewal operation failed due to timeout",null,"Token Renewal Failed"),p(h.RENEW_STATUS+o,r.Canceled)}},e.loadFrameTimeout)}function G(e,t){setTimeout(()=>{const n=j(t);n.src&&"about:blank"!==n.src||(n.src=e,G(e,t))},500)}function q(e){e&&window.location.replace(e)}function M(e){if(!o||!o.profile)return e;if(o.profile.sid&&-1!==e.indexOf("&prompt=none"))c("sid",e)||(e+="&sid="+l(o.profile.sid));else if(o.profile.upn&&(c("login_hint",e)||(e+="&login_hint="+l(o.profile.upn)),!c("domain_hint",e)&&o.profile.upn.indexOf("@")>-1)){var t=o.profile.upn.split("@");e+="&domain_hint="+l(t[t.length-1])}return e}function F(t){const n=function(e){let t=i(e);var n;if(t)try{let e=(n=(n=t.JWSPayload).replace(/-/g,"+").replace(/_/g,"/"),decodeURIComponent(escape(window.atob(n))));return e?JSON.parse(e):void 0}catch(e){}}(t);if(w(n,"aud"))return n.aud.toLowerCase()===e.clientId.toLowerCase()?{userName:n.upn||n.email,profile:n}:void 0}function Q(e=window.location.hash){if(!R(e))return;let n,r;const o=y[y.length-1];o&&o.opener&&o.opener._AuthenticationContextInstance?(n=o.opener._adalInstance,r=!0):window.parent&&window.parent._adalInstance&&(n=window.parent._adalInstance);let a,i,s,l=n.getRequestInfo(e);a=r||window.parent!==window?n._callBackMappedToRenewStates[l.stateResponse]:n.config.callback,n.saveTokenFromHash(l),l.requestType===t.RENEW_TOKEN&&window.parent?(i=l.parameters.access_token||l.parameters.id_token,s="access_token"):l.requestType===t.LOGIN&&(i=l.parameters.id_token,s="id_token");try{a&&a(l.parameters.error_description,i,l.parameters.error,s)}catch(e){}window.parent!==window||r||(n.config.navigateToLoginRequestUrl?window.location.href=m(h.LOGIN_REQUEST):window.location.hash="")}let X=(t,n)=>e.instance+e.tenant+"/oauth2/authorize"+N(t,e,n);function j(e){return document.getElementById(e)||(document.body.insertAdjacentHTML("beforeEnd",`<iframe name="${e}" id="${e}" style="display:none"></iframe>`),window.frames&&window.frames[e])}return window._adalInstance={config:e,login:function(){if(k)return;k=!0;const t=T(),n=window.location.href;e.state=t,a=T(),p(h.LOGIN_REQUEST,n),p(h.LOGIN_ERROR,""),p(h.STATE_LOGIN,t,!0),p(h.NONCE_IDTOKEN,a,!0),p(h.ERROR,""),p(h.ERROR_DESCRIPTION,"");const r=X("id_token")+"&nonce="+l(a);e.displayCall?e.displayCall(r):e.popUp?(p(h.STATE_LOGIN,""),v.push(t),W(t,e.clientId,e.callback),L(r)):q(r)},logout:function(){let t;if(function(){p(h.LOGIN_REQUEST,""),p(h.SESSION_STATE,""),p(h.STATE_LOGIN,""),p(h.STATE_RENEW,""),v=[],p(h.NONCE_IDTOKEN,""),p(h.IDTOKEN,""),p(h.ERROR,""),p(h.ERROR_DESCRIPTION,""),p(h.LOGIN_ERROR,""),p(h.LOGIN_ERROR,"");var e=m(h.TOKEN_KEYS);if(!S(e)){e=e.split("|");for(var t=0;t<e.length&&""!==e[t];t++)p(h.ACCESS_TOKEN_KEY+e[t],""),p(h.EXPIRATION_KEY+e[t],0)}p(h.TOKEN_KEYS,"")}(),o=null,e.logOutUri)t=e.logOutUri;else{let n="";e.postLogoutRedirectUri&&(n="post_logout_redirect_uri="+l(e.postLogoutRedirectUri)),t=e.instance+e.tenant+"/oauth2/logout?"+n}q(t)},getUser:function(){if(!o){const e=m(h.IDTOKEN);e&&(o=F(e))}return o},registerCallback:W,acquireToken:function(r,a){if(!r){const e="resource is required";return void a(e,null,e)}const i=function(t){if(!u(t))return;const n=m(h.ACCESS_TOKEN_KEY+t),r=m(h.EXPIRATION_KEY+t);if(r&&r>g()+e.expireOffsetSeconds)return n;p(h.ACCESS_TOKEN_KEY+t,""),p(h.EXPIRATION_KEY+t,0)}(r);if(i)a(null,i,null);else if(o||e.extraQueryParameter&&-1!==e.extraQueryParameter.indexOf("login_hint"))K[r]?W(K[r],r,a):(U=t.RENEW_TOKEN,r===e.clientId?o?D(a):D(a,n.ID_TOKEN):o?b(r,a):b(r,a,n.ID_TOKEN));else{const e="User login is required";a(e,null,e)}},acquireTokenPopup:function(n,r,a,i){if(function(t){let n;return t?o?C&&(n="Acquire token interactive is already in progress"):n="User login is required":n="Resource is required",n&&e.callback(n,null,n),!n}(n)){var s=T()+"|"+n;e.state=s,v.push(s),U=t.RENEW_TOKEN;var c=d(X("token",n),"prompt");if(c+="&prompt=select_account",r&&(c+=r),a){if(-1!==c.indexOf("&claims"))throw new Error("Claims cannot be passed as an extraQueryParameter");c+="&claims="+l(a)}c=M(c),C=!0,W(s,n,i),L(c,n,i)}},getRequestInfo:function(e){const n={valid:!1,parameters:{},stateMatch:!1,stateResponse:"",requestType:t.UNKNOWN},r=_(E(e));if(!r)return n;if(n.parameters=r,w(r,"error_description")||w(r,"access_token")||w(r,"id_token")){if(n.valid=!0,!w(r,"state"))return n;if(n.stateResponse=r.state,function(e){const n=m(h.STATE_LOGIN);if(n)for(const r of n.split("||"))if(r===e.stateResponse)return e.requestType=t.LOGIN,e.stateMatch=!0,!0;const r=m(h.STATE_RENEW);if(r)for(const n of r.split("||"))if(n===e.stateResponse)return e.requestType=t.RENEW_TOKEN,e.stateMatch=!0,!0;return!1}(n))return n;if(!n.stateMatch&&window.parent){n.requestType=U;for(const e of v)if(e===n.stateResponse){n.stateMatch=!0;break}}}return n},saveTokenFromHash:function(n){p(h.ERROR,""),p(h.ERROR_DESCRIPTION,"");let a=O(n.stateResponse);if(w(n.parameters,"error_description"))p(h.ERROR,n.parameters.error),p(h.ERROR_DESCRIPTION,n.parameters.error_description),n.requestType===t.LOGIN&&(k=!1,p(h.LOGIN_ERROR,n.parameters.error_description));else if(n.stateMatch){let t;if(w(n.parameters,"session_state")&&p(h.SESSION_STATE,n.parameters.session_state),w(n.parameters,"access_token")&&(u(a)||(t=m(h.TOKEN_KEYS)||"",p(h.TOKEN_KEYS,t+a+"|")),p(h.ACCESS_TOKEN_KEY+a,n.parameters.access_token),p(h.EXPIRATION_KEY+a,I(n.parameters.expires_in))),w(n.parameters,"id_token"))if(k=!1,o=F(n.parameters.id_token),o&&o.profile)f(o)?(p(h.IDTOKEN,n.parameters.id_token),a=e.loginResource?e.loginResource:e.clientId,u(a)||(t=m(h.TOKEN_KEYS)||"",p(h.TOKEN_KEYS,t+a+"|")),p(h.ACCESS_TOKEN_KEY+a,n.parameters.id_token),p(h.EXPIRATION_KEY+a,o.profile.exp)):(p(h.LOGIN_ERROR,"Nonce received: "+o.profile.nonce+" is not same as requested: "+m(h.NONCE_IDTOKEN)),o=null);else{const e="invalid id_token",t="Invalid id_token. id_token: "+n.parameters.id_token;n.parameters.error=e,n.parameters.error_description=t,p(h.ERROR,e),p(h.ERROR_DESCRIPTION,t)}}else{const e="Invalid_state",t="Invalid_state. state: "+n.stateResponse;n.parameters.error=e,n.parameters.error_description=t,p(h.ERROR,e),p(h.ERROR_DESCRIPTION,t)}p(h.RENEW_STATUS+a,r.Completed)},loginInProgress:()=>k,handleWindowCallback:Q,_callBackMappedToRenewStates:A,_callBacksMappedToRenewStates:P}},a=e=>{p(h.STATE_RENEW,""),p(h.ERROR,""),p(h.ERROR_DESCRIPTION,""),u(e)&&(p(h.ACCESS_TOKEN_KEY+e,""),p(h.EXPIRATION_KEY+e,0))},i=e=>{if(S(e))return;let t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);return!t||t.length<4?void 0:{header:t[1],JWSPayload:t[2],JWSSig:t[3]}},s=t=>e({popUp:!1,instance:"https://login.microsoftonline.com/",loginResource:t.clientId,laodFrameTimeout:6e3,expireOffsetSeconds:300,navigateToLoginRequestUrl:!0,tenant:"common",redirectUri:window.location.href.split("?")[0].split("#")[0],callback:()=>{}},t),l=e=>encodeURIComponent(e),c=(e,t)=>new RegExp("[\\?&]"+e+"=").test(t),d=(e,t)=>e.replace(new RegExp("(\\&"+t+"=)[^&]+"),"").replace(new RegExp("("+t+"=)[^&]+&"),"").replace(new RegExp("("+t+"=)[^&]+"),""),p=(e,t,n=!1)=>{if(n){let n=m(e)||"";K.setItem(e,n+t+"||")}else K.setItem(e,t)},u=e=>{let t=m(h.TOKEN_KEYS);return!S(t)&&t.indexOf(e+"|")>-1},E=e=>e.indexOf("#/")>-1?e.substring(e.indexOf("#/")+2):e.indexOf("#")>-1?e.substring(1):e,R=e=>{const t=_(E(e));return w(t,"error_description")||w(t,"access_token")||w(t,"id_token")},_=e=>{let t=/\+/g,n=/([^&=]+)=([^&]*)/g,r=e=>decodeURIComponent(e.replace(t," ")),o={},a=n.exec(e);for(;a;)o[r(a[1])]=r(a[2]),a=n.exec(e);return o},f=e=>{const t=m(h.NONCE_IDTOKEN);if(t)for(const n of t.split("||"))if(n===e.profile.nonce)return!0;return!1},O=e=>{if(e){let t=e.indexOf("|");if(t>-1&&t+1<e.length)return e.substring(t+1)}return""},I=e=>(e||(e=3599),g()+parseInt(e,10)),N=(e,t,n)=>{if(!t)return"";const r=["?response_type="+e,"client_id="+l(t.clientId)];n&&r.push("resource="+l(n)),r.push("redirect_uri="+l(t.redirectUri)),r.push("state="+l(t.state)),w(t,"slice")&&r.push("slice="+l(t.slice)),w(t,"extraQueryParameter")&&r.push(t.extraQueryParameter);const o=t.correlationId||T();return r.push("client-request-id="+l(o)),r.join("&")},T=()=>{let e=new Uint8Array(16);return crypto.getRandomValues(e),e[6]|=64,e[6]&=79,e[8]|=128,e[8]&=191,e=e.map(e=>{let t=e.toString(16);for(;t.length<2;)t="0"+t;return t}),e[0]+e[1]+e[2]+e[3]+"-"+e[4]+e[5]+"-"+e[6]+e[7]+"-"+e[8]+e[9]+"-"+e[10]+e[11]+e[12]+e[13]+e[14]+e[15]},m=e=>K.getItem(e),S=e=>!e||!e.length,w=(e,t)=>Object.hasOwnProperty.call(e,t),g=()=>Math.round(Date.now()/1e3);var h;!function(e){e.TOKEN_KEYS="adal.token.keys",e.ACCESS_TOKEN_KEY="adal.access.token.key",e.EXPIRATION_KEY="adal.expiration.key",e.STATE_LOGIN="adal.state.login",e.STATE_RENEW="adal.state.renew",e.NONCE_IDTOKEN="adal.nonce.idtoken",e.SESSION_STATE="adal.session.state",e.USERNAME="adal.username",e.IDTOKEN="adal.idtoken",e.ERROR="adal.error",e.ERROR_DESCRIPTION="adal.error.description",e.LOGIN_REQUEST="adal.login.request",e.LOGIN_ERROR="adal.login.error",e.RENEW_STATUS="adal.token.renew.status"}(h||(h={}));const K=(()=>{function e(e){const t=window[e];if(!t)return!1;const n="__test__";return t.setItem(n,n),t.getItem(n)===n&&(t.removeItem(n),!t.getItem(n))}return e("localStorage")?localStorage:e("sessionStorage")?sessionStorage:{getItem(){},setItem(){}}})();var k;!function(e){e[e.Error=0]="Error",e[e.Warn=1]="Warn",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose"}(k||(k={}));export{o as AuthenticationContext,k as LogLevel,a as clearCacheForResource};
//# sourceMappingURL=adal.modern.js.map
